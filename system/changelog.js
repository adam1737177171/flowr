const changeloglist = [
    {text: `- Changed daily streak petal rarity calculation
- Added two new petals
- Added a use for Waterlogged Compass
- Buffed Corn 
- Buffed Leaf significantly
- Nerfed Starfish slightly
- Buffed Yucca
- Buffed Rose
- Buffed Dahlia under Omnipotent
- Slightly buffed Wing
- Buffed Omnipotent Orange
- Buffed Heavy damage
- Slightly nerfed Rice
- Added slowdown stats for Celestial mobs
- Heavily buffed the chances for a Centipede or Evil Centipede in the Garden biome
- Buffed the chances for a Soil mob by 17x, but nerfed its droprates significantly
- Buffed the chances for a Soil mob in a special wave by 100x
- Waterlogged Compass is now a rare daily
`, date: `December 20, 2024`},
    {text: `- As a temporary solution to us developers being busy, we've extended game progression by 1 rarity until we can create a proper endgame
`, date: `December 10, 2024`},
    {text: `- Reduced the reload time of Sapphire
`, date: `December 6, 2024`},
        {text: `- Announcement: We'd like you to try our new game: evadesx.io!
- Evades X is a skill-based multiplayer dodging game that involves playing and making maps with endlessly creative mechanics.
- It is under active development by the OG 2 developers who founded flowr!
`, date: `November 27, 2024`},
    {text: `- Over the past few weeks, numerous small balancing changes have been made to the Arena in small updates
- Added new petal
- Adjusted some renders to look better
- Air's health nerf is calculated differently now
`, date: `October 8, 2024`},
    {text: `- Added a new exclusive petal. This petal will have many future usages, albeit not implemented yet.
- Added a way to obtain the new exclusive petal.
- Players now spawn / respawn in suitable positions in the Arena
- Summons in the Arena now target flowers
- Summons in the Arena spawned from different flowers no longer instakill each other
- Summons in the Arena now deal significant damage to other flowers
- Summons in the Arena now have knockback to other flowers
- Salt has been nerfed in the Arena
- Heavy now works in the Arena
- Mandible has been heavily nerfed in the Arena
- Pollen has been slightly nerfed in the Arena
- Trident has been heavily nerfed in the Arena
- Rose, Dahlia, and Shell are no longer absorbed by enemy flowers in the Arena
- All summoner petals balanced for Arena usage
- Rematching in the Arena now has a 5 second cooldown in the main room
- Arena petal scaling now applies to 1v1s as well
- Knockback now works in the Arena
- Husk has been slightly nerfed in the Arena
- Bone has been slightly nerfed in the Arena
- Powder has been buffed in the Arena
- Stinger has been nerfed in the Arena
- Healing petals in the Arena are now more balanced relative to each other
- Nerfed the Cactus boss
- Fixed Agar.io Cell stats in the mob gallery
- Heavily optimized the inventory in the Arena biome
- Fixed bugs related to incorrect petal layouts displayed in the Arena biome`, date: `September 29, 2024`},
    {text: `- Buffed back Salt completely, but fixed a bug where Salt and Sponge would ignore the max reflection damage
- Slightly adjusted Pearl stats
- Bud no longer heals players at full health
- Sponge period now scales with rarity
- Increased quality of life with how petal stats are displayed
- Added fourth biome (still in testing, won't be very balanced)`, date: `September 19, 2024`},
    {text: `- Bosses of mobs that are rarer now drop less loot, and bosses of mobs that are common now drop more loot
- Salt buffed back significantly
- Fangs & Coral buffed
- Added a new boss in each biome and balanced boss spawning rates slightly`, date: `September 18, 2024`},
    {text: `- Bug fixes
- Many more Omnipotent petals are now special. This may inadverdently buff them even if they aren't listed as a buffed petal below.
- Buffed petals based on stats: Magnet (Omnipotent), Powder (Omnipotent)
- Nerfed petals based on stats: Salt (Omega+), Bud (Mythic+), Starfish (slightly), Pearl (not noticable)`, date: `September 15, 2024`},
    {text: `- Buffed the Jelly petal
- Slightly buffed Pollen's damage
- Bosses past Wave 200 now continue to give better loot but at a much slower pace
- Removed Omnipotent attempt announcements
- Changed the look, radius, or mini-petal layout of some Omnipotent petals`, date: `September 11, 2024`},
    {text: `- Omnipotent Shell has been buffed
- Nerfed some impossible and cancerous bosses
- Shell petal range buffed`, date: `August 31, 2024`},
    {text: `- Fangs damage buffed
- Stinger damage buffed
- Dahlia petal health buffed
- Yucca healing buffed a lot
- Starfish healing slightly reduced`, date: `July 5, 2024`},
    {text: `- Players above Level 150 can now overfill a private squad to 5 players. These squads have increased mob health such that they give less loot per player.
- Stinger damage buffed significantly, Stinger reload lengthened
- Fangs healing and damage buffed
- High rarity Powder speed increased
- Peas damage buffed
- Sand damage buffed
- Slowdown rebalanced
- Super+ Web is now 1 large web instead of 3 mini-webs
- Sponge petal health nerfed
- Mandible reworked`, date: `July 4, 2024`},
    {text: `- Rock and Salt buffed`, date: `July 2, 2024`},
    {text: `- Boss chances buffed
- Rebalanced some petal chances from streak rewards
- XP buffed for Supreme+ mobs
- Rock petal buffed, now has extremely slight knockback, faster reload and more health`, date: `July 1, 2024`},
    {text: `- Some bosses were nerfed`, date: `June 28, 2024`},
    {text: `- Petal knockback rebalanced`, date: `June 27, 2024`},
    {text: `- Very small droprates now have higher precision
- Added multi-charged Omnipotent mobs for the tryhards who never touched grass
- Dandelion spawn rate buffed
- Corn reload buffed 10 -> 9s
- Shell reload buffed 2.1 -> 1.7s
- Oranges damage buffed 14.3 -> 14.4
- Rock damage buffed 14 -> 19
- Supreme+ Magnet range buffed
- Divine+ Rubber knockback buffed
- Air now inflates you
- Supreme+ Bubble knockback nerfed
- Soil health-increase buffed 180 -> 200`, date: `June 26, 2024`},
    {text: `- Added charged Omnipotent mobs, known as Astral mobs
- Mobs no longer shrink after Wave 175
- Rebalanced Omnipotent petals
- High rarity Honey reworked`, date: `June 12, 2024`},
    {text: `- Non-full squads now have less mob health (-17%/-33%/-48% for trio/duo/solo respectively)`, date: `April 14, 2024`},
    {text: `- Pearl now does 4x less damage to bosses
- 2-player and 3-player squads now have less mob health (-15%/-30%/-45% -> -16%/-32%/-45%)
- Summoned pets are now slightly smaller and less massive
`, date: "April 11, 2024"},
    {text: `- Pearl armor buffed -34 -> -14
- Pearl health buffed 510 -> 910
- Fixed a bug where the whole Stinger cluster would die even if just one would have killed the enemy
- Corn, Bone, Pearl are the only petals that "stick" now
- Leaf damage buffed 20 -> 24
- Leaf health buffed 10 -> 12
- Fabled+ Leaf is a cluster of 3 now!
- Stinger health no longer splits with tringer/pinger
- Stinger damage 142 -> 145
- Stinger health 4 -> 5
- Rice damage buffed 12 -> 13.5
`, date: "April 10, 2024"},
    {text: `- Peas and Grapes have been reworked! They now have much more health when fired, and bounce off walls!
- Fixed a bug where low rarity compasses had super fast reload
- Missile health has been slightly nerfed, 28 -> 26
- Stinger damage buffed 112 -> 142
- Stinger reload nerfed 3.4 -> 4
- Sand damage buffed 8.95 -> 9
- Light damage buffed 25 -> 26
- Faster damage buffed 14 -> 14.5
- Faster rotation nerfed; rad/s now transitions smoothly from 2.7 at Ultra to 6.3 at Omnipotent.
- Rice damage buffed 15.5 -> 16
- Rice now has 0 reload.
- High-rarity rice has been made big!
- Petals like Corn now "stick" to mobs, similar to florr.
- Starfish healing buffed 11.8 -> 13.5 
- Starfish damage nerfed 38 -> 30 (Leaf should be the one with damage; Starfish should be for quick healing!)
- Starfish health buffed 10 -> 11
- Leaf damage buffed 18 -> 20
- Salt reflection scales much faster, matching the widening gap in enemy HP and damage.
- Fixed a bug where petals would not take damage if enemies were instakilled (this is TECHNICALLY not a pearl nerf, just a bugfix).

Overall, this update aims to shift the meta to some new and interesting stuff as it's been a while since we had some interesting builds.
`, date: "April 9, 2024"},
    {text: `- Compass is actually useful now!
- Stinger petal damage buffed`, date: "March 28, 2024"},
    {text: `- Game is finally named flowr.fun
- Fixed a few more disconnection bugs`, date: "March 23, 2024"},
    {text: `- Reconnecting has been made EVEN MORE effective
- Captcha chances have been reduced significantly
- Captcha no longer requires reload to solve
- Large server optimizations made
- Rice damage buffed 15 -> 15.5`, date: "March 22, 2024"},
    {text: `- A changelog has now been added. Only large or influential updates are shown below this point.
- Added 2 new petals
- Changed how the Stinger petal looks
- Bone petal health buffed
- Cactus petal damage buffed
- Cactus petal reload nerfed
- Cactus petal gives less maximum health than before`, date: "March 21, 2024"},
    
    {text: `- Petal Health is now visible on your loadout`, date: "March 16, 2024"},
    {text: `- Revamped Pearl`, date: "February 6, 2024"},
    {text: `- Added reconnection logic
- Added the ability to change passwords`, date: "January 10, 2024"},
    {text: `- Added bosses`, date: "January 4, 2024"},
    {text: `- Added Mob Gallery
- Less flowers in the room now reduces mob health`, date: "January 1, 2024"},
    {text: `- Petal Reload is now visible on your loadout`, date: "December 27, 2023"},
    {text: `- Added Ocean biome`, date: "December 21, 2023"},
    {text: `- Flowr officially released`, date: "September 24, 2023"},
    {text: `- Work on the project has begun`, date: "July 17, 2023"},

]


class Changelog {
    constructor(){
        this.entries = [];



        this.x = 110;
        this.y = 20;
        this.w = 500;
        this.h = 50 * 10 + 7;

        this.offset = -this.h - 40;
        this.targetOffset = -this.h - 40;
        this.active = false;


        this.scroll = 5;
        this.render = {scroll: this.scroll};

        this.menuHeights = {beginning: 0, end: this.h};
        this.scrollbar = {top: 0, bottom: 0, renderTop: 0, renderBottom: 0, length: 150};


        // this.scrollbar.bottom = (canvas.h - this.h - 20) + 60 - this.scrollbar.length * 7/8
        // this.scrollbar.top = this.scrollbar.bottom + this.scrollbar.length / 2
        const scrollBarProjections = {
            top: (20) + this.scrollbar.length*.5 + 60,
            bottom: (this.h + 20) - this.scrollbar.length*.5 + 30
        }
        this.scrollbar.top = this.scrollbar.bottom = scrollBarProjections.top + this.scrollbar.length;
        this.scrollbar.renderBottom = this.scrollbar.bottom;
        this.scrollbar.renderTop = this.scrollbar.top;

        this.draggingScrollBar = false;

        this.hoveringOverScrollbar = false;
        this.scrollBarActive = true;
        this.hoveringOverX = false;
    }
    toggle(){
        this.active = !this.active;
        if(this.active){
            this.generateEntries();
            // open
            this.targetOffset = 0;
        } else {
            // close
            this.targetOffset = -this.h - 40;
        }
    }
    resizeScroll(){
        if(this.resizeFlag !== undefined) {
            return;
        }
        const scrollBarProjections = {
            top: (20) + this.scrollbar.length*.5 + 60,
            bottom: (this.h + 20) - this.scrollbar.length*.5 + 30
        }
        this.scrollbar.top = this.scrollbar.bottom = scrollBarProjections.top + this.scrollbar.length;

        this.resizeFlag = true;
    }
    mouseDown({mouseX, mouseY}){
      
        if(
            mouseX < this.w - 16 + 12 + 110 &&
            mouseX > this.w - 16 - 12 + 110 &&
            mouseY > (this.scrollbar.bottom) &&
            mouseY < (this.scrollbar.top)
        ){
            this.draggingScrollBar = true;
        }
    }
    mouseUp({mouseX, mouseY}){
        this.draggingScrollBar = false;
        // delete this.scrollbarMouseOffset;
    }
    updateScroll(/*delta*/{x,y}, {mouseX, mouseY}){
        if(this.active !== true){
            return;
        }
        
        if(mouseX < 110 || mouseY < 20 || mouseX > 110 + this.w || mouseY > this.h + 20){
            return;
        }

        this.scroll -= y;
        if(this.scroll > 0) this.scroll = 0;
        else if(this.scroll < this.totalPetalHeight) this.scroll = this.totalPetalHeight;
    }
    mouseMove({mouseX, mouseY}){
        //console.log(mouseX, mouseY);
        if(
            mouseX < this.w - 16 + 12 + 110 &&
            mouseX > this.w - 16 - 12 + 110 &&
            mouseY > (this.scrollbar.bottom) &&
            mouseY < (this.scrollbar.top)
        ){
            this.hoveringOverScrollbar = true;
            //console.log("TRUE");
            // setCursor('pointer');
            // this.scrollbarMouseOffset = 0//(this.scrollbar.top) * ((this.h - 82 - 16) / this.h) + 82 + (canvas.h - this.h - 20) - mouseY;
        } else {
            this.hoveringOverScrollbar = false;
        }
        
        if(this.draggingScrollBar !== true){
            
            return;
        }
        
        const scrollBarProjections = {
            top: (20) + this.scrollbar.length*.5 + 60,
            bottom: (this.h + 20) - this.scrollbar.length*.5 + 30
        }

        const mouseProjections = {
            top: scrollBarProjections.top - this.scrollbar.length * .25,
            bottom: scrollBarProjections.bottom + this.scrollbar.length * .33
        }

        let ratio = (mouseY - mouseProjections.top) / (mouseProjections.bottom - mouseProjections.top);
        if(ratio < 0){
            ratio = 0;
        } else if(ratio > 1){
            ratio = 1;
        }
        //console.log(ratio);

        // console.log(mouseY - scrollBarProjections.top);

        
        this.scroll = ratio * (this.totalPetalHeight) //* ((this.h - 82 - 16 * 2) / this.h);
       
    }
    draw(){
        //if(!this.active){return};
        ctx.textBaseline = 'middle';
        ctx.fontKerning = "none";
        ctx.letterSpacing = "-.1px";
        this.offset = interpolate(this.offset, this.targetOffset, 0.3);
        

        this.currentHeight = 5;

        ctx.translate(this.x, this.y + this.offset);
        ctx.fillStyle = '#9bb56b';
        ctx.strokeStyle = '#7f9458';
        ctx.lineWidth = 8;

        ctx.beginPath();
        ctx.roundRect(0, 0, this.w, this.h, 3);
        ctx.fill();
        ctx.stroke();
        ctx.closePath();

        this.render.scroll = interpolate(this.render.scroll, this.scroll, 0.0070 * dt);

        ctx.save();
        ctx.beginPath();
        ctx.roundRect(0, 80, this.w, this.h - 80, 3);
        ctx.clip();
        let entrypadding = 10;

        let yoff = 100 + entrypadding;
        for(let i = 0; i < this.entries.length; i++){
            yoff +=this.entries[i].h/2
            this.renderEntry(this.entries[i], yoff);
            yoff += this.entries[i].h/2 + entrypadding;
        }
        ctx.restore();

        ctx.beginPath();
        ctx.roundRect(0, 0, this.w, this.h, 3);
        ctx.stroke();
        ctx.closePath();

        ctx.font = `900 30px 'Ubuntu'`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";

        ctx.fillStyle = 'white';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 4;
        ctx.strokeText("Changelog", this.w/2, 40);
        ctx.fillText("Changelog", this.w/2, 40);

        

        this.menuHeights = {
            beginning: 100 + entrypadding, //- petalContainerSize * 1/2,
            end:   yoff - this.h + 70 + 80//+ petalContainerSize * 4
        }

       
            
        let padding = 100;
     
        const scrollBarProjections = {
            top: (20) + this.scrollbar.length*.5 + 60,
            bottom: (this.h + 20) - this.scrollbar.length*.5 + 30
        }
        

        this.totalPetalHeight = (this.menuHeights.beginning - this.menuHeights.end);

       
        if(this.scroll > 0) this.scroll = 0;
        else if(this.scroll < this.totalPetalHeight) this.scroll = this.totalPetalHeight;

        const ratio = this.scroll / this.totalPetalHeight;
         //console.log(ratio);

        this.scrollbar.bottom = interpolate(scrollBarProjections.top, scrollBarProjections.bottom, ratio) - this.scrollbar.length / 2//this.scroll / (this.totalPetalHeight) * (scrollBarProjections.bottom - scrollBarProjections.top) + scrollBarProjections.top + this.scrollbar.length / 2 - (canvas.h - this.h - 20);
        // this.scrollbar.bottom = this.scroll / (this.totalPetalHeight + this.scrollbar.length) * (scrollBarProjections.bottom - scrollBarProjections.top) + scrollBarProjections.top - this.scrollbar.length/2;
        this.scrollbar.top = this.scrollbar.bottom + this.scrollbar.length / 2//this.scrollbar.bottom - this.scrollbar.length / 2;
    
        this.scrollbar.renderTop = interpolate(this.scrollbar.renderTop, this.scrollbar.top, this.draggingScrollBar ? 0.28 : 0.08);
        this.scrollbar.renderBottom = interpolate(this.scrollbar.renderBottom, this.scrollbar.bottom, this.draggingScrollBar ? 0.28 : 0.08);

        // console.log(this.scrollBarActive);
        if(this.scrollBarActive !== false){
            ctx.translate(0, -(20));
            ctx.strokeStyle = '#7f9458';
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(this.w - 16, (this.scrollbar.renderTop) /** ((this.h - 82 - 16) / this.h) + 82*/);
            ctx.lineTo(this.w - 16, (this.scrollbar.renderBottom) /** ((this.h - 82 - 16) / this.h) + 82*/);
            ctx.stroke();
            ctx.closePath();
            ctx.translate(0, (20));
        }

        if(this.active === true){
            if(mouse.canvasX > this.x + this.w - 7.5 - 30 - 3 && mouse.canvasY > this.y + 7.5 + 3 && mouse.canvasX < this.x + this.w - 7.5 - 3 && mouse.canvasY < this.y + 7.5 + 30 + 3){
                ctx.fillStyle = "#c16666";
                setCursor('pointer');
                this.hoveringOverX = true;
            } else {
                // if(this.hoveringOverButton === false){
                //     document.body.style.cursor = 'auto';
                // }
                this.hoveringOverX = false;
                ctx.fillStyle = '#c1565e';
            }
        } else {
            ctx.fillStyle = '#c1565e';
            this.hoveringOverX = false;
        }

        ctx.translate(-3, 3);
        ctx.strokeStyle = '#90464b';
        ctx.lineWidth = 5;
        ctx.beginPath();
        ctx.roundRect(this.w - 7.5 - 30, 7.5, 30, 30, 6);
        ctx.fill();
        ctx.stroke();
        ctx.closePath();

        ctx.lineWidth = 4.75;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#cccccc';
        ctx.beginPath();
        ctx.moveTo(this.w - 30, 30);
        ctx.lineTo(this.w - 7.5 * 2, 7.5 + 7.5);
        ctx.stroke();
        ctx.closePath();
        ctx.beginPath();
        ctx.moveTo(this.w - 7.5 * 2, 30);
        ctx.lineTo(this.w - 30, 7.5 + 7.5);
        ctx.stroke();
        ctx.closePath();
        ctx.translate(3, -3);

        ctx.translate(-this.x, -this.y - this.offset);
    }

    renderEntry(entry, yoffset){

        if(this.render.scroll + yoffset < 0 || this.render.scroll + yoffset > this.h + 100) return;

        ctx.font = `900 ${entry.fontSize ?? 19}px 'Ubuntu'`;
        ctx.textAlign = "left";
        ctx.textBaseline = "middle";

        ctx.fillStyle = 'white';
        ctx.strokeStyle = 'black';
        ctx.lineWidth = 2;

        if(entry.type == 'divider'){
            ctx.strokeStyle = '#7f9458';
            ctx.lineWidth = 8;
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(20, yoffset + this.render.scroll);
            ctx.lineTo(this.w - 20 - 16, yoffset + this.render.scroll);
            ctx.stroke();
            ctx.closePath();

        }else if(entry.type == 'date'){
            ctx.lineWidth = 3;
            ctx.strokeText(entry.text, 20, yoffset + this.render.scroll);
            ctx.fillText(entry.text, 20, yoffset + this.render.scroll);
        }else {
            ctx.strokeText(entry.text, 28, yoffset + this.render.scroll);
            ctx.fillText(entry.text, 28, yoffset + this.render.scroll);
        }

        
    }

    getLines(ctx, text, maxWidth) {
        //maxWidth *= window.innerWidth/canvas.w;
        
        var words = text.split(" ");
        var lines = [];
        var currentLine = words[0];
    
        for (var i = 1; i < words.length; i++) {
            var word = words[i];
            var width = ctx.measureText(currentLine + " " + word).width;
            if (width < maxWidth) {
                currentLine += " " + word;
            } else {
                lines.push(currentLine);
                currentLine = word;
            }
        }
        lines.push(currentLine);
        return lines;
    }


    generateEntries(){
        let ret = []
        for(let entry of changeloglist){
            ret.push({
                type: "date",
                text: entry.date,
                fontSize: 22,
                h: 34
            })
            let paragraphs = entry.text.split("\n");
            for(let paragraph of paragraphs){
                ctx.font = `900 16px 'Ubuntu'`;
                let lines = this.getLines(ctx, paragraph, this.w - 54);
                for(let line of lines){
                    ret.push({
                        type: "text",
                        text: line,
                        fontSize: 16,
                        h: 15
                    })
                }
            }
            ret.push({
                type: "divider",
                h: 20
            })
            
            
        }
        this.entries = ret;
    }
    
    
}

const changelog = new Changelog();
